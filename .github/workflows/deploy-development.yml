name: Deploy Development
on:
  repository_dispatch:
    types: [trigger-dev-deploy] # Custom event name
env:
  HOSTS_FILE: inventories/development/hosts.yml
  HOSTS_TEMPLATE: inventories/development/hosts.yml.template
jobs:
  deploy-development:
    runs-on: ubuntu-latest
    steps:
      - name: Check payload
        run: |
          echo "Short SHA: ${{ github.event.client_payload.short_sha_tag }}"
          echo "Service Name: ${{ github.event.client_payload.service_name }}"
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Update .env on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ vars.DEVELOPMENT_HOST }}
          username: ${{ vars.DEPLOY_USER }}
          key: ${{ secrets.DEVELOPMENT_DEPLOY_PRIVATE_KEY }}
          timeout: 5m
          command_timeout: 1m
          script: |
            TAG="${{ github.event.client_payload.short_sha_tag || 'latest' }}"
            sed -i "s/^AUTO_GO_APP_VERSION=.*/AUTO_GO_APP_VERSION=$TAG/g" /opt/docker/.env
            cat /opt/docker/.env
      - name: Generate Ansible Inventory
        run: |
          cp ${{env.HOSTS_TEMPLATE}} ${{env.HOSTS_FILE}}
          sed -i "s/<DEVELOPMENT_HOST>/${{vars.DEVELOPMENT_HOST}}/g" ${{env.HOSTS_FILE}}
          cat ${{env.HOSTS_FILE}}
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEVELOPMENT_DEPLOY_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 400 ~/.ssh/id_ed25519
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_ed25519
      - name: Install Ansible
        run: |
          sudo apt update
          sudo apt install -y software-properties-common
          sudo add-apt-repository --yes --update ppa:ansible/ansible
          sudo apt install -y ansible
      - name: Run Ansible Playbook
        run: |
          ansible-playbook -i ${{env.HOSTS_FILE}} \
            deploy_development.yml \
            --extra-vars "service_name=${{ github.event.client_payload.service_name }}" \
            --vault-password-file=<(echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}")
        env:
          ANSIBLE_SSH_USER: ${{ vars.DEPLOY_USER }}
          ANSIBLE_SSH_KEY: ~/.ssh/id_ed25519
